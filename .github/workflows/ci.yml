name: CI Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  QT_VERSION: '6.6.0'

jobs:
  build-linux:
    name: Linux (Ubuntu 22.04)
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: 'linux'
        target: 'desktop'
        cache: true

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libgl1-mesa-dev \
          libgdal-dev \
          libgeos-dev \
          libproj-dev \
          libsqlite3-dev \
          libspatialite-dev \
          libxcb-cursor0 \
          libfuse2

    - name: Configure CMake
      run: |
        cmake --preset linux-release

    - name: Build
      run: cmake --build --preset linux-release

  build-windows:
    name: Windows (MSVC)
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Qt (MSVC)
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2019_64'
        cache: true

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Install Ninja
      run: choco install ninja

    - name: Clone vcpkg
      run: git clone https://github.com/microsoft/vcpkg.git

    - name: Bootstrap vcpkg
      run: .\vcpkg\bootstrap-vcpkg.bat
      shell: cmd

    - name: Restore vcpkg cache
      uses: actions/cache@v4
      with:
        path: |
          vcpkg/installed
          vcpkg/packages
        key: ${{ runner.os }}-vcpkg-ci-v1-${{ hashFiles('CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-ci-v1-

    - name: Install vcpkg dependencies
      run: .\vcpkg\vcpkg install gdal:x64-windows geos:x64-windows proj:x64-windows --recurse
      shell: cmd

    - name: Configure CMake
      run: |
        cmake --preset windows-vcpkg
      shell: pwsh

    - name: Build
      run: cmake --build --preset windows-vcpkg
